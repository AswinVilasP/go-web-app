name: Deploy Go App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”‘ SSH into EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          script: |
            set -e  # Exit on error
            export PATH=\$PATH:/usr/local/go/bin
            export PATH=$PATH:/bin:/usr/bin:/usr/local/bin

            echo "ğŸ”¹ Logging into EC2 instance..."
            cd /home/ubuntu/deployments

            # Use GitHub Actions Build ID as deployment version
            BUILD_ID=${{ github.run_id }}
            NEW_DEPLOY_DIR="/home/ubuntu/deployments/app-$BUILD_ID"

            echo "ğŸš€ Cloning latest code from GitHub..."
            git clone https://github.com/AswinVilasP/go-web-app.git $NEW_DEPLOY_DIR
            cd $NEW_DEPLOY_DIR

            echo "ğŸ›  Installing dependencies..."
            go mod tidy

            echo "ğŸ“¦ Creating .env file from GitHub Secrets..."
            echo "${{ secrets.ENV_FILE }}" > .env
            chmod 600 .env  # Secure file permissions

            # echo "ğŸ”¨ Building Go application..."
            # go build -o main

            echo "ğŸ“¦ Checking Backup Directory..."
            if [ ! -d "/home/ubuntu/app-backup" ]; then
                mkdir -p /home/ubuntu/app-backup
            fi

            echo "ğŸ“¦ Backing up the current version..."
            if [ -d "/home/ubuntu/app/current" ]; then
                # Remove any existing backup
                if [ -f "/home/ubuntu/app-backup/app-$BUILD_ID.zip" ]; then
                    rm -f /home/ubuntu/app-backup/app-$BUILD_ID.zip
                fi

                # Create a new backup
                zip -r /home/ubuntu/app-backup/app-$BUILD_ID.zip /home/ubuntu/app/current
            fi

            echo "ğŸ“¦ Creating symlink for Blue-Green Deployment..."
            ln -sfn /home/ubuntu/deployments/app-$BUILD_ID/* /home/ubuntu/app/current/

            echo "ğŸš€ Restarting application using systemd..."
            sudo systemctl restart myapp.service

            echo "ğŸ©º Checking if the application is running correctly..."
            sleep 5
            if ! systemctl is-active --quiet myapp.service; then
              echo "âš ï¸ Deployment failed! Rolling back..."
              if [ -d "/home/ubuntu/app-backup" ]; then
                unzip app-$BUILD_ID.zip
                ln -sfn /home/ubuntu/app-backup /home/ubuntu/app/current
                sudo systemctl restart myapp.service
                echo "âœ… Rolled back to previous working version!"
              fi
              exit 1  # Fail the GitHub Actions pipeline
            fi

            echo "ğŸ§¹ Cleaning up older versions (keeping only one backup)..."
            ls -dt /home/ubuntu/deployments/app-* | grep -v "app-$BUILD_ID" | grep -v "app-backup" | xargs rm -rf || true

            echo "âœ… Deployment successful!"
